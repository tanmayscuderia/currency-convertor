import { ComponentFixture, fakeAsync, flush, TestBed } from '@angular/core/testing';
import data from '../../assets/json/config.json';
import { DisplayComponent } from './display.component';
import { CurrencyService } from '../../services/currency.service';
import { HttpClientModule } from '@angular/common/http';
import { HttpClientTestingModule, HttpTestingController } from '@angular/common/http/testing';
import { HeaderModule } from '../header/header.module';
import { DescriptionComponentModule } from '../description/description.module';
import { ConvertorComponentModule } from '../convertor/convertor.module';
import { ChosenCurrenciesConvertedGridModule } from '../chosen-currencies-converted-grid/chosen-currencies-converted-grid.module';
import { DynamicKeyStringValueInterface } from 'src/assets/js/interface';
import { of } from 'rxjs';

describe('DisplayComponent', () => {
  let component: DisplayComponent;
  let fixture: ComponentFixture<DisplayComponent>;
  let mockCurrencyService: jasmine.SpyObj<CurrencyService>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [
        HttpClientTestingModule,
        ConvertorComponentModule,
        DescriptionComponentModule,
        ConvertorComponentModule,
        HttpClientModule,
        ChosenCurrenciesConvertedGridModule,
        HeaderModule
      ],
      declarations: [DisplayComponent],
      providers: [{
        provide: CurrencyService,
        useValue: jasmine.createSpyObj('CurrencyService', ['getAllSymbols', 'latestService'])
      }]
    })
      .compileComponents();

    fixture = TestBed.createComponent(DisplayComponent);
    component = fixture.componentInstance;
    component.currencyRates = MOCK_CURRENCY_RATES;
    mockCurrencyService = TestBed.get(CurrencyService);

    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should set config', ()=> {
    expect(component.configData).toEqual(data);
  });

  it('should set default convertor form value', () => {
    expect(component.convertorForm.value).toEqual({
      amount: '1',
      from: 'USD',
      to: 'GBP'
    });
  });

  it('should set converted value by default to 0', () => {
    expect(component.setConvertedValue).toBe(0);
  });

  it('should change the value of from and to based on options given', () => {
    expect(component.convertorForm.value).toEqual({
      amount: '1',
      from: 'USD',
      to: 'GBP'
    });

    component.setConvertOptionFromNavber('GBP,EUR');
    
    expect(component.convertorForm.value).toEqual({
      amount: '1',
      from: 'GBP',
      to: 'EUR'
    });

    // should set new converted value on changing from and to as it triggers convertCurrency function
    expect(component.setConvertedValue).toBe(1.1331569770937293);
  });

  it('latest service should return all currencies with latest value from service', fakeAsync(() => {
    const stream = of(MOCK_LATEST_SERVICE);
 
    mockCurrencyService.latestService.and.returnValue(stream);
    
    expect(component.currencyRates).toEqual(MOCK_LATEST_SERVICE.rates);
  }));
});

const MOCK_CURRENCY_RATES: DynamicKeyStringValueInterface = {
  "AED": 3.672598,
  "AFN": 87.503383,
  "ALL": 106.449787,
  "AMD": 393.269673,
  "ANG": 1.803513,
  "AOA": 503.700502,
  "ARS": 176.371681,
  "AUD": 1.484153,
  "AWG": 1.8,
  "AZN": 1.701546,
  "BAM": 1.838031,
  "BBD": 2.020506,
  "BDT": 106.113769,
  "BGN": 1.842724,
  "BHD": 0.377019,
  "BIF": 2062,
  "BMD": 1,
  "BND": 1.347818,
  "BOB": 6.914829,
  "BRL": 5.258401,
  "BSD": 1.000667,
  "BTC": 0.000060258304,
  "BTN": 82.885282,
  "BWP": 12.845906,
  "BYN": 2.525832,
  "BYR": 19600,
  "BZD": 2.017123,
  "CAD": 1.360698,
  "CDF": 2029.999836,
  "CHF": 0.92904,
  "CLF": 0.031276,
  "CLP": 862.999737,
  "CNY": 6.978698,
  "COP": 4773.49,
  "CRC": 581.191441,
  "CUC": 1,
  "CUP": 26.5,
  "CVE": 104.24994,
  "CZK": 22.81805,
  "DJF": 177.720098,
  "DKK": 7.00765,
  "DOP": 56.050169,
  "DZD": 137.374009,
  "EGP": 24.767802,
  "ERN": 15,
  "ETB": 53.601504,
  "EUR": 0.94239,
  "FJD": 2.206101,
  "FKP": 0.831257,
  "GBP": 0.83165,
  "GEL": 2.699831,
  "GGP": 0.831257,
  "GHS": 9.74979,
  "GIP": 0.831257,
  "GMD": 62.000099,
  "GNF": 8779.99985,
  "GTQ": 7.850464,
  "GYD": 209.48416,
  "HKD": 7.79405,
  "HNL": 24.680479,
  "HRK": 7.1148,
  "HTG": 147.102219,
  "HUF": 378.590084,
  "IDR": 15789.9,
  "ILS": 3.538398,
  "IMP": 0.831257,
  "INR": 82.838023,
  "IQD": 1460.5,
  "IRR": 41800.000085,
  "ISK": 143.160143,
  "JEP": 0.831257,
  "JMD": 153.071639,
  "JOD": 0.709303,
  "JPY": 134.470502,
  "KES": 123.404944,
  "KGS": 85.679859,
  "KHR": 4117.00034,
  "KMF": 463.325033,
  "KPW": 899.980871,
  "KRW": 1274.95007,
  "KWD": 0.30635,
  "KYD": 0.833858,
  "KZT": 463.581387,
  "LAK": 17344.999836,
  "LBP": 1523.000128,
  "LKR": 365.754213,
  "LRD": 154.475012,
  "LSL": 17.120095,
  "LTL": 2.95274,
  "LVL": 0.60489,
  "LYD": 4.82502,
  "MAD": 10.47982,
  "MDL": 19.173374,
  "MGA": 4465.000386,
  "MKD": 57.903937,
  "MMK": 2101.460591,
  "MNT": 3445.896002,
  "MOP": 8.028268,
  "MRO": 356.999828,
  "MUR": 43.647877,
  "MVR": 15.411164,
  "MWK": 1023.505548,
  "MXN": 19.424799,
  "MYR": 4.4225,
  "MZN": 63.830327,
  "NAD": 17.119858,
  "NGN": 446.639756,
  "NIO": 36.3947,
  "NOK": 9.89746,
  "NPR": 132.616602,
  "NZD": 1.58563,
  "OMR": 0.384925,
  "PAB": 1.000667,
  "PEN": 3.810504,
  "PGK": 3.519616,
  "PHP": 56.140973,
  "PKR": 226.374976,
  "PLN": 4.419299,
  "PYG": 7322.500916,
  "QAR": 3.641499,
  "RON": 4.659027,
  "RSD": 110.589756,
  "RUB": 72.750066,
  "RWF": 1065,
  "SAR": 3.759445,
  "SBD": 8.2544,
  "SCR": 13.256975,
  "SDG": 571.999865,
  "SEK": 10.47304,
  "SGD": 1.35002,
  "SHP": 1.377402,
  "SLE": 18.689459,
  "SLL": 18825.000269,
  "SOS": 569.502803,
  "SRD": 31.856498,
  "STD": 20697.981008,
  "SVC": 8.755838,
  "SYP": 2512.464671,
  "SZL": 17.120077,
  "THB": 34.80301,
  "TJS": 10.227239,
  "TMT": 3.5,
  "TND": 3.124028,
  "TOP": 2.353894,
  "TRY": 18.717401,
  "TTD": 6.793786,
  "TWD": 30.807197,
  "TZS": 2333.999717,
  "UAH": 36.957386,
  "UGX": 3734.552528,
  "USD": 1,
  "UYU": 38.621733,
  "UZS": 11204.999804,
  "VEF": 1653026.122573,
  "VES": 16.545797,
  "VND": 23635,
  "VUV": 119.041459,
  "WST": 2.724427,
  "XAF": 616.448797,
  "XAG": 0.042563,
  "XAU": 0.000554,
  "XCD": 2.70255,
  "XDR": 0.75191,
  "XOF": 615.000113,
  "XPF": 112.649829,
  "YER": 250.349902,
  "ZAR": 17.11898,
  "ZMK": 9001.197417,
  "ZMW": 17.997538,
  "ZWL": 321.999592
}

const MOCK_SYMBOL_SERVICE = {
  "success": true,
  "symbols": {
      "AED": "United Arab Emirates Dirham",
      "AFN": "Afghan Afghani",
      "ALL": "Albanian Lek",
      "AMD": "Armenian Dram",
      "ANG": "Netherlands Antillean Guilder",
      "AOA": "Angolan Kwanza",
      "ARS": "Argentine Peso",
      "AUD": "Australian Dollar",
      "AWG": "Aruban Florin",
      "AZN": "Azerbaijani Manat",
      "BAM": "Bosnia-Herzegovina Convertible Mark",
      "BBD": "Barbadian Dollar",
      "BDT": "Bangladeshi Taka",
      "BGN": "Bulgarian Lev",
      "BHD": "Bahraini Dinar",
      "BIF": "Burundian Franc",
      "BMD": "Bermudan Dollar",
      "BND": "Brunei Dollar",
      "BOB": "Bolivian Boliviano",
      "BRL": "Brazilian Real",
      "BSD": "Bahamian Dollar",
      "BTC": "Bitcoin",
      "BTN": "Bhutanese Ngultrum",
      "BWP": "Botswanan Pula",
      "BYN": "New Belarusian Ruble",
      "BYR": "Belarusian Ruble",
      "BZD": "Belize Dollar",
      "CAD": "Canadian Dollar",
      "CDF": "Congolese Franc",
      "CHF": "Swiss Franc",
      "CLF": "Chilean Unit of Account (UF)",
      "CLP": "Chilean Peso",
      "CNY": "Chinese Yuan",
      "COP": "Colombian Peso",
      "CRC": "Costa Rican Colón",
      "CUC": "Cuban Convertible Peso",
      "CUP": "Cuban Peso",
      "CVE": "Cape Verdean Escudo",
      "CZK": "Czech Republic Koruna",
      "DJF": "Djiboutian Franc",
      "DKK": "Danish Krone",
      "DOP": "Dominican Peso",
      "DZD": "Algerian Dinar",
      "EGP": "Egyptian Pound",
      "ERN": "Eritrean Nakfa",
      "ETB": "Ethiopian Birr",
      "EUR": "Euro",
      "FJD": "Fijian Dollar",
      "FKP": "Falkland Islands Pound",
      "GBP": "British Pound Sterling",
      "GEL": "Georgian Lari",
      "GGP": "Guernsey Pound",
      "GHS": "Ghanaian Cedi",
      "GIP": "Gibraltar Pound",
      "GMD": "Gambian Dalasi",
      "GNF": "Guinean Franc",
      "GTQ": "Guatemalan Quetzal",
      "GYD": "Guyanaese Dollar",
      "HKD": "Hong Kong Dollar",
      "HNL": "Honduran Lempira",
      "HRK": "Croatian Kuna",
      "HTG": "Haitian Gourde",
      "HUF": "Hungarian Forint",
      "IDR": "Indonesian Rupiah",
      "ILS": "Israeli New Sheqel",
      "IMP": "Manx pound",
      "INR": "Indian Rupee",
      "IQD": "Iraqi Dinar",
      "IRR": "Iranian Rial",
      "ISK": "Icelandic Króna",
      "JEP": "Jersey Pound",
      "JMD": "Jamaican Dollar",
      "JOD": "Jordanian Dinar",
      "JPY": "Japanese Yen",
      "KES": "Kenyan Shilling",
      "KGS": "Kyrgystani Som",
      "KHR": "Cambodian Riel",
      "KMF": "Comorian Franc",
      "KPW": "North Korean Won",
      "KRW": "South Korean Won",
      "KWD": "Kuwaiti Dinar",
      "KYD": "Cayman Islands Dollar",
      "KZT": "Kazakhstani Tenge",
      "LAK": "Laotian Kip",
      "LBP": "Lebanese Pound",
      "LKR": "Sri Lankan Rupee",
      "LRD": "Liberian Dollar",
      "LSL": "Lesotho Loti",
      "LTL": "Lithuanian Litas",
      "LVL": "Latvian Lats",
      "LYD": "Libyan Dinar",
      "MAD": "Moroccan Dirham",
      "MDL": "Moldovan Leu",
      "MGA": "Malagasy Ariary",
      "MKD": "Macedonian Denar",
      "MMK": "Myanma Kyat",
      "MNT": "Mongolian Tugrik",
      "MOP": "Macanese Pataca",
      "MRO": "Mauritanian Ouguiya",
      "MUR": "Mauritian Rupee",
      "MVR": "Maldivian Rufiyaa",
      "MWK": "Malawian Kwacha",
      "MXN": "Mexican Peso",
      "MYR": "Malaysian Ringgit",
      "MZN": "Mozambican Metical",
      "NAD": "Namibian Dollar",
      "NGN": "Nigerian Naira",
      "NIO": "Nicaraguan Córdoba",
      "NOK": "Norwegian Krone",
      "NPR": "Nepalese Rupee",
      "NZD": "New Zealand Dollar",
      "OMR": "Omani Rial",
      "PAB": "Panamanian Balboa",
      "PEN": "Peruvian Nuevo Sol",
      "PGK": "Papua New Guinean Kina",
      "PHP": "Philippine Peso",
      "PKR": "Pakistani Rupee",
      "PLN": "Polish Zloty",
      "PYG": "Paraguayan Guarani",
      "QAR": "Qatari Rial",
      "RON": "Romanian Leu",
      "RSD": "Serbian Dinar",
      "RUB": "Russian Ruble",
      "RWF": "Rwandan Franc",
      "SAR": "Saudi Riyal",
      "SBD": "Solomon Islands Dollar",
      "SCR": "Seychellois Rupee",
      "SDG": "Sudanese Pound",
      "SEK": "Swedish Krona",
      "SGD": "Singapore Dollar",
      "SHP": "Saint Helena Pound",
      "SLE": "Sierra Leonean Leone",
      "SLL": "Sierra Leonean Leone",
      "SOS": "Somali Shilling",
      "SRD": "Surinamese Dollar",
      "STD": "São Tomé and Príncipe Dobra",
      "SVC": "Salvadoran Colón",
      "SYP": "Syrian Pound",
      "SZL": "Swazi Lilangeni",
      "THB": "Thai Baht",
      "TJS": "Tajikistani Somoni",
      "TMT": "Turkmenistani Manat",
      "TND": "Tunisian Dinar",
      "TOP": "Tongan Paʻanga",
      "TRY": "Turkish Lira",
      "TTD": "Trinidad and Tobago Dollar",
      "TWD": "New Taiwan Dollar",
      "TZS": "Tanzanian Shilling",
      "UAH": "Ukrainian Hryvnia",
      "UGX": "Ugandan Shilling",
      "USD": "United States Dollar",
      "UYU": "Uruguayan Peso",
      "UZS": "Uzbekistan Som",
      "VEF": "Venezuelan Bolívar Fuerte",
      "VES": "Sovereign Bolivar",
      "VND": "Vietnamese Dong",
      "VUV": "Vanuatu Vatu",
      "WST": "Samoan Tala",
      "XAF": "CFA Franc BEAC",
      "XAG": "Silver (troy ounce)",
      "XAU": "Gold (troy ounce)",
      "XCD": "East Caribbean Dollar",
      "XDR": "Special Drawing Rights",
      "XOF": "CFA Franc BCEAO",
      "XPF": "CFP Franc",
      "YER": "Yemeni Rial",
      "ZAR": "South African Rand",
      "ZMK": "Zambian Kwacha (pre-2013)",
      "ZMW": "Zambian Kwacha",
      "ZWL": "Zimbabwean Dollar"
  }
}

const MOCK_LATEST_SERVICE = {
  "success": true,
  "timestamp": 1672260424,
  "base": "USD",
  "date": "2022-12-28",
  "rates": {
      "AED": 3.672598,
      "AFN": 87.503383,
      "ALL": 106.449787,
      "AMD": 393.269673,
      "ANG": 1.803513,
      "AOA": 503.700502,
      "ARS": 176.371681,
      "AUD": 1.484153,
      "AWG": 1.8,
      "AZN": 1.701546,
      "BAM": 1.838031,
      "BBD": 2.020506,
      "BDT": 106.113769,
      "BGN": 1.842724,
      "BHD": 0.377019,
      "BIF": 2062,
      "BMD": 1,
      "BND": 1.347818,
      "BOB": 6.914829,
      "BRL": 5.258401,
      "BSD": 1.000667,
      "BTC": 0.000060258304,
      "BTN": 82.885282,
      "BWP": 12.845906,
      "BYN": 2.525832,
      "BYR": 19600,
      "BZD": 2.017123,
      "CAD": 1.360698,
      "CDF": 2029.999836,
      "CHF": 0.92904,
      "CLF": 0.031276,
      "CLP": 862.999737,
      "CNY": 6.978698,
      "COP": 4773.49,
      "CRC": 581.191441,
      "CUC": 1,
      "CUP": 26.5,
      "CVE": 104.24994,
      "CZK": 22.81805,
      "DJF": 177.720098,
      "DKK": 7.00765,
      "DOP": 56.050169,
      "DZD": 137.374009,
      "EGP": 24.767802,
      "ERN": 15,
      "ETB": 53.601504,
      "EUR": 0.94239,
      "FJD": 2.206101,
      "FKP": 0.831257,
      "GBP": 0.83165,
      "GEL": 2.699831,
      "GGP": 0.831257,
      "GHS": 9.74979,
      "GIP": 0.831257,
      "GMD": 62.000099,
      "GNF": 8779.99985,
      "GTQ": 7.850464,
      "GYD": 209.48416,
      "HKD": 7.79405,
      "HNL": 24.680479,
      "HRK": 7.1148,
      "HTG": 147.102219,
      "HUF": 378.590084,
      "IDR": 15789.9,
      "ILS": 3.538398,
      "IMP": 0.831257,
      "INR": 82.838023,
      "IQD": 1460.5,
      "IRR": 41800.000085,
      "ISK": 143.160143,
      "JEP": 0.831257,
      "JMD": 153.071639,
      "JOD": 0.709303,
      "JPY": 134.470502,
      "KES": 123.404944,
      "KGS": 85.679859,
      "KHR": 4117.00034,
      "KMF": 463.325033,
      "KPW": 899.980871,
      "KRW": 1274.95007,
      "KWD": 0.30635,
      "KYD": 0.833858,
      "KZT": 463.581387,
      "LAK": 17344.999836,
      "LBP": 1523.000128,
      "LKR": 365.754213,
      "LRD": 154.475012,
      "LSL": 17.120095,
      "LTL": 2.95274,
      "LVL": 0.60489,
      "LYD": 4.82502,
      "MAD": 10.47982,
      "MDL": 19.173374,
      "MGA": 4465.000386,
      "MKD": 57.903937,
      "MMK": 2101.460591,
      "MNT": 3445.896002,
      "MOP": 8.028268,
      "MRO": 356.999828,
      "MUR": 43.647877,
      "MVR": 15.411164,
      "MWK": 1023.505548,
      "MXN": 19.424799,
      "MYR": 4.4225,
      "MZN": 63.830327,
      "NAD": 17.119858,
      "NGN": 446.639756,
      "NIO": 36.3947,
      "NOK": 9.89746,
      "NPR": 132.616602,
      "NZD": 1.58563,
      "OMR": 0.384925,
      "PAB": 1.000667,
      "PEN": 3.810504,
      "PGK": 3.519616,
      "PHP": 56.140973,
      "PKR": 226.374976,
      "PLN": 4.419299,
      "PYG": 7322.500916,
      "QAR": 3.641499,
      "RON": 4.659027,
      "RSD": 110.589756,
      "RUB": 72.750066,
      "RWF": 1065,
      "SAR": 3.759445,
      "SBD": 8.2544,
      "SCR": 13.256975,
      "SDG": 571.999865,
      "SEK": 10.47304,
      "SGD": 1.35002,
      "SHP": 1.377402,
      "SLE": 18.689459,
      "SLL": 18825.000269,
      "SOS": 569.502803,
      "SRD": 31.856498,
      "STD": 20697.981008,
      "SVC": 8.755838,
      "SYP": 2512.464671,
      "SZL": 17.120077,
      "THB": 34.80301,
      "TJS": 10.227239,
      "TMT": 3.5,
      "TND": 3.124028,
      "TOP": 2.353894,
      "TRY": 18.717401,
      "TTD": 6.793786,
      "TWD": 30.807197,
      "TZS": 2333.999717,
      "UAH": 36.957386,
      "UGX": 3734.552528,
      "USD": 1,
      "UYU": 38.621733,
      "UZS": 11204.999804,
      "VEF": 1653026.122573,
      "VES": 16.545797,
      "VND": 23635,
      "VUV": 119.041459,
      "WST": 2.724427,
      "XAF": 616.448797,
      "XAG": 0.042563,
      "XAU": 0.000554,
      "XCD": 2.70255,
      "XDR": 0.75191,
      "XOF": 615.000113,
      "XPF": 112.649829,
      "YER": 250.349902,
      "ZAR": 17.11898,
      "ZMK": 9001.197417,
      "ZMW": 17.997538,
      "ZWL": 321.999592
  }
}
